{% extends "data_base.html" %}

{% block title %}{{ data.phecode }} - {{ data.term }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>{{data.description}}</h3>

    <div id="phecodeDetails" class="mb-4">
        <p class="p-2 bg-light rounded">
            <span><a href="/phecode/{{ data.phecode }}" target="_blank">Phecode: {{ data.phecode }}</a></span> |
            <span>Sex: {{ data.sex }}</span> |
            <span>Affected: <strong>{{ data.affected }}</strong></span> |
            <span>Excluded: {{ data.excluded }} ({{ data.phecode_exclude }})</span> |
            <span>Disease: {{ data.phecode_group }}</span>
        </p>
        <ul class="meaning-list">
            {% for meaning in data.meaning %}
            <li>{{ meaning }}</li>
            {% endfor %}
        </ul>
    </div>
    <!-- Term information display -->
    <h3>{{ data.termname }}</h3>

    <div id="termDetails" class="mb-4">
        <p class="p-2 bg-light rounded">
            <span>Term: {{ data.term }}</span> |
            <span>{{ data.domainlen }} domains</span> |
            <span>{{ data.genelen }} genes</span>:
            {{ data.genes }}
        </p>
    </div>
    <!-- Show table of genes, variants, druggability, pharma projects, gwas known -->
    <div class="btn-group mb-3">
        <button class="btn btn-primary" onclick="loadTable2()">Show by Gene</button>
        <button class="btn btn-secondary" onclick="loadTable1()">Show by Variant</button>
        <button class="btn btn-info" onclick="loadVariantDetailTable()">Show Variant Details</button>
    </div>

</div>
<div class="container-fluid">
    <div class="p-3 bg-light m-1">

        <div id="tableContainer" class="table-responsive">
            <div id="tableContainer" class="mb-4">
                <table id="resultsTable" class="table table-striped table-bordered" style="width: 100%;"></table>
            </div>
        </div>
    </div>
</div>

<!-- Customized scripts -->
<script>
    const phecode = "{{ data.phecode }}";
    const term = "{{ data.term }}";

    // Function to initialize the DataTable with consistent formatting
    function renderDataTable(data, columns, defaultColumns, numColumns) {
        if ($.fn.DataTable.isDataTable('#resultsTable')) {
            $('#resultsTable').DataTable().destroy();
        }

        // Format the data to match variant.html style
        const formattedData = data.map(row => ({
            "Variant": row.Variant,
            "Gene": row.Gene,
            "AA_Change": row.AA_Change,
            "HMM_Score": row.HMM_Score,
            "TDL": row.TDL,
            "TBIO": row.TBIO,
            "Classification": row.Classification,
            "Drug_Program_Indication": row.Drug_Program_Indication,
            "GWAS_P": row.GWAS_P ? `${parseFloat(row.GWAS_P).toExponential(2)}<br/>` : 'N/A',
            "GWAS_OR": row.GWAS_OR ? `${parseFloat(row.GWAS_OR).toFixed(2)}<br/>` : 'N/A'
        }));

        // Define column order to match variant.html style
        const columnDefinitions = [
            { data: "Variant", title: "Variant" },
            { data: "Gene", title: "Gene" },
            { data: "AA_Change", title: "AA Change" },
            { data: "HMM_Score", title: "HMM Score" },
            { data: "TDL", title: "TDL" },
            { data: "TBIO", title: "TBIO" },
            { data: "Classification", title: "Classification" },
            { data: "Drug_Program_Indication", title: "Drug Program" },
            { data: "GWAS_P", title: "GWAS P" },
            { data: "GWAS_OR", title: "GWAS OR" },
        ];

        // Add visible property to column definitions based on defaultColumns
        columnDefinitions.forEach(col => {
            col.visible = defaultColumns.includes(col.data);
        });

        // Initialize DataTable with consistent options
        $('#resultsTable').DataTable({
            data: formattedData,
            columns: columnDefinitions,
            order: [[8, 'asc']],
            responsive: true,
            autoWidth: false,
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'colvis',
                    text: 'Select Columns',
                    columns: ':not(:first-child)'
                }
            ],
            columnDefs: [
                {
                    targets: 0,  // Variant column
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return `<a href="/variant/${data}" target="_blank">${data}</a>`;
                        }
                        return data;
                    }
                },
                {
                    // Target all numeric columns
                    targets: numColumns.map(col => columnDefinitions.findIndex(def => def.data === col)),
                    className: 'text-end'  // Bootstrap class for right alignment
                }
            ]
        });
    }

    // Function to load Table 1 (by Variant)
    function loadTable1() {
        const encodedTerm = encodeURIComponent(term);
        fetch(`/phecode/${phecode}/term/${encodedTerm}/tableVar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(resultData => {
                renderDataTable(resultData.data, resultData.columns, resultData.defaultColumns, resultData.numColumns);
            })
            .catch(error => {
                console.error('Error loading Table 1:', error);
                alert('Failed to load table data. Check console for details.');
            });
    }

    // Function to load Table 2 (by Gene)
    function loadTable2() {
        const encodedTerm = encodeURIComponent(term);
        fetch(`/phecode/${phecode}/term/${encodedTerm}/tableGene`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(resultData => {
                renderDataTable(resultData.data, resultData.columns, resultData.defaultColumns, resultData.numColumns);
            })
            .catch(error => {
                console.error('Error loading Table 2:', error);
                alert('Failed to load table data. Check console for details.');
            });
    }

    // Function to load Variant Detail Table
    function loadVariantDetailTable(flush = false) {
        const encodedTerm = encodeURIComponent(term);
        const url = `/phecode/${phecode}/term/${encodedTerm}/tableVariantDetail`;
        // Add flush parameter to POST body in URL
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ flush: flush })
        })
            .then(response => response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.error || 'Error fetching data');
                }
                return data;
            }))
            .then(resultData => {
                renderDataTable(resultData.data, resultData.columns, resultData.defaultColumns, resultData.numColumns);
            })
            .catch(error => {
                console.error('Error loading Variant Detail Table:', error);
                alert('Failed to load table data: ' + error.message);
            });
    }
</script>
{% endblock %}