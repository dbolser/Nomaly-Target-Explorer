{% extends "data_base.html" %}

{% block title %}{{ data.phecode }} - {{ data.term }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>{{data.description}}</h3>

    <div id="phecodeDetails" class="mb-4">
        <p class="p-2 bg-light rounded">
            <span><a href="/phecode/{{ data.phecode }}" target="_blank">Phecode: {{ data.phecode }}</a></span> |
            <span>Sex: {{ data.sex }}</span> |
            <span>Affected: <strong>{{ data.affected }}</strong></span> |
            <span>Excluded: {{ data.excluded }} ({{ data.phecode_exclude }})</span> |
            <span>Disease: {{ data.phecode_group }}</span>
        </p>
        <ul class="meaning-list">
            {% for meaning in data.meaning %}
            <li>{{ meaning }}</li>
            {% endfor %}
        </ul>
    </div>
    <!-- Term information display -->
    <h3>{{ data.termname }}</h3>

    <div id="termDetails" class="mb-4">
        <p class="p-2 bg-light rounded">
            <span>Term: {{ data.term }}</span> |
            <span>{{ data.domainlen }} domains</span> |
            <span>{{ data.genelen }} genes</span>:
            {{ data.genes }}
        </p>
    </div>

</div>
<div class="container-fluid">
    <div class="p-3 bg-light m-1">
        <!-- Added alert message -->
        <div class="alert alert-info" role="alert">
            The table below shows all variants involved in the prediction for this term in the study cohort, including
            variant-level information (frequency, counts), Nomaly annotation (intolerance score HMM, genotype specific
            scores), and allele-level disease association (GWAS).
        </div>

        <!-- Added collapsible info box -->
        <div class="mb-3">
            <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#columnInfo"
                aria-expanded="false" aria-controls="columnInfo">
                Show Column Descriptions
            </button>
            <div class="collapse mt-2" id="columnInfo">
                <div class="card card-body">
                    <h5>Visible Columns:</h5>
                    <ul>
                        <li><strong>Variant:</strong> GRCh38_Ref/Alt</li>
                        <li><strong>HMM Score:</strong> Evolutionary intolerance by protein domain</li>
                        <li><strong>Classification:</strong> PHAROS</li>
                        <li><strong>vs00, vs01, vs11:</strong> Genotype specific score. Rare genotypes with high HMM
                            gets a higher score</li>
                        <li><strong>GWAS P, OR:</strong> Allele-level test by {{ data.phecode_group }} (disease
                            dependent)</li>
                        <li><strong>RSID:</strong> Reference SNP ID</li>
                    </ul>

                    <h5>Hidden Columns:</h5>
                    <ul>
                        <li><strong>Variant level:</strong> Click the variant to get variant level information</li>
                        <li><strong>From GWAS:</strong> Frequency in affected (F_A), frequency in unaffected (F_U)</li>
                        <li><strong>Gene Information:</strong> Drug Program Indication, TDL, TBIO</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="alert alert-warning" role="alert">
            NOTE: the table can take long to load if thousands of variants were involved. Please don't refresh. (You
            will get an error code if you refresh!).
        </div>
</div>
<div class="container-fluid">
    <div class="p-3 bg-light m-1">
        <!-- Added alert message -->
        <div class="alert alert-info" role="alert">
            The table below shows all variants involved in the prediction for this term in the study cohort, including
            variant-level information (frequency, counts), Nomaly annotation (intolerance score HMM, genotype specific
            scores), and allele-level disease association (GWAS).
        </div>

        <!-- Added collapsible info box -->
        <div class="mb-3">
            <button class="btn btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#columnInfo"
                aria-expanded="false" aria-controls="columnInfo">
                Show Column Descriptions
            </button>
            <div class="collapse mt-2" id="columnInfo">
                <div class="card card-body">
                    <h5>Visible Columns:</h5>
                    <ul>
                        <li><strong>Variant:</strong> GRCh38_Ref/Alt</li>
                        <li><strong>HMM Score:</strong> Evolutionary intolerance by protein domain</li>
                        <li><strong>Classification:</strong> PHAROS</li>
                        <li><strong>vs00, vs01, vs11:</strong> Genotype specific score. Rare genotypes with high HMM
                            gets a higher score</li>
                        <li><strong>GWAS P, OR:</strong> Allele-level test by {{ data.phecode_group }} (disease
                            dependent)</li>
                        <li><strong>RSID:</strong> Reference SNP ID</li>
                    </ul>

                    <h5>Hidden Columns:</h5>
                    <ul>
                        <li><strong>Variant level:</strong> Click the variant to get variant level information</li>
                        <li><strong>From GWAS:</strong> Frequency in affected (F_A), frequency in unaffected (F_U)</li>
                        <li><strong>Gene Information:</strong> Drug Program Indication, TDL, TBIO</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="alert alert-warning" role="alert">
            NOTE: the table can take long to load if thousands of variants were involved. Please don't refresh. (You
            will get an error code if you refresh!).
        </div>

        <div id="tableContainer" class="table-responsive">
            <div id="tableContainer" class="mb-4">
                <table id="resultsTable" class="table table-striped table-bordered" style="width: 100%;"></table>
            </div>
        </div>
    </div>
</div>

<!-- Customized scripts -->
<script>
    const phecode = "{{ data.phecode }}";
    const term = "{{ data.term }}";

    // Function to initialize the DataTable with consistent formatting
    function renderDataTable(data, columns, defaultColumns, numColumns) {
        if ($.fn.DataTable.isDataTable('#resultsTable')) {
            $('#resultsTable').DataTable().destroy();
        }

        const columnDefinitions = columns.map(col => ({
            data: col,
            title: col.replace(/_/g, ' '),
            visible: defaultColumns.includes(col)
        }));

        // Find the GWAS P column index
        const gwasPIndex = columns.findIndex(col => col === 'GWAS_P');

        $('#resultsTable').DataTable({
            data: data,
            columns: columnDefinitions,
            order: [[gwasPIndex, 'asc']],  // Default sort by GWAS P
            responsive: true,
            autoWidth: false,
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'colvis',
                    text: 'Select Columns',
                    columns: ':not(:first-child)'
                }
            ],
            columnDefs: [{
                targets: 0,  // Variant column
                render: function (data, type, row) {
                    if (type === 'display') {
                        return variantUtils.createLink(data);
                    }
                    if (type === 'sort') {
                        const parts = data.split(/[_:]/);
                        const chr = isNaN(parts[0]) ? parts[0] : parseInt(parts[0]);
                        return (typeof chr === 'number' ?
                            chr.toString().padStart(3, '0') :
                            'ZZZ' + chr) + '_' + parts[1].padStart(10, '0');
                    }
                    return data;
                }
            }]
        });
    }

    // Function to load Variant Detail Table
    function loadVariantDetailTable() {
        const encodedTerm = encodeURIComponent(term);
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const flush = urlParams.get('flush') === 'true';
        const url = `/phecode/${phecode}/term/${encodedTerm}/tableVariantDetail?flush=${flush}`;

        console.log('Sending request to:', url);

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                flush: flush  // Pass through the flush parameter from URL
            })
        })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(resultData => {
                console.log('Received data:', resultData);
                renderDataTable(resultData.data, resultData.columns, resultData.defaultColumns, resultData.numColumns);
            })
            .catch(error => {
                console.error('Error loading Variant Detail Table:', error);
                alert('Failed to load table data: ' + error.message);
            });
    }

    // Load variant details when the page loads
    document.addEventListener('DOMContentLoaded', function () {
        loadVariantDetailTable();
    });
</script>
{% endblock %}