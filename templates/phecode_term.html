{% extends "data_base.html" %}

{% block title %}{{ data.phecode }} - {{ data.term }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>{{data.description}}</h3>

    <div id="phecodeDetails" class="mb-4">
        <p class="p-2 bg-light rounded">
            <span><a href="/phecode/{{ data.phecode }}" target="_blank">Phecode: {{ data.phecode }}</a></span> |
            <span>Sex: {{ data.sex }}</span> |
            <span>Affected: <strong>{{ data.affected }}</strong></span> |
            <span>Excluded: {{ data.excluded }} ({{ data.phecode_exclude }})</span> |
            <span>Disease: {{ data.phecode_group }}</span>
        </p>
        <ul class="meaning-list">
            {% for meaning in data.meaning %}
            <li>{{ meaning }}</li>
            {% endfor %}
        </ul>
    </div>
    <!-- Term information display -->
    <h3>{{ data.termname }}</h3>

    <div id="termDetails" class="mb-4">
        <p class="p-2 bg-light rounded">
            <span>Term: {{ data.term }}</span> |
            <span>{{ data.domainlen }} domains</span> |
            <span>{{ data.genelen }} genes</span>:
            {{ data.genes }}
        </p>
    </div>
    <!-- Show table of genes, variants, druggability, pharma projects, gwas known -->
    <div class="btn-group mb-3">
        <button class="btn btn-primary" onclick="loadTable2()">Show by Gene</button>
        <button class="btn btn-secondary" onclick="loadTable1()">Show by Variant</button>
        <button class="btn btn-info" onclick="loadVariantDetailTable()">Show Variant Detailed View</button>

    </div>

</div>
<div class="container-fluid">
    <div class="p-3 bg-light m-1">

        <div id="tableContainer" class="table-responsive">
            <style>
                /* Match variant.html styling */
                #resultsTable td:has(br) {
                    text-align: right !important;
                }
            </style>
            <div id="tableContainer" class="mb-4">
                <table id="resultsTable" class="table table-striped table-bordered" style="width: 100%;"></table>
            </div>
        </div>
    </div>
</div>

<!-- Customized scripts -->
<script>
    // Function to initialize the DataTable with consistent formatting
    function renderDataTable(data, columns, defaultColumns, numColumns) {
        if ($.fn.DataTable.isDataTable('#resultsTable')) {
            $('#resultsTable').DataTable().destroy();
        }

        // Format the data to match variant.html style
        const formattedData = data.map(row => ({
            "Variant": row.Variant,
            "Gene": row.Gene,
            "AA_Change": row.AA_Change,
            "HMM_Score": row.HMM_Score,
            "Counts": `${row.Counts}`,  // Already formatted as cases<br/>controls
            "RefAF": `${row.RefAF}`,  // Already formatted as cases<br/>controls
            "AltAF": `${row.AltAF}`,  // Already formatted as cases<br/>controls
            "Ref_HMOZ": `${row.Ref_HMOZ}`,
            "Alt_HMOZ": `${row.Alt_HMOZ}`,
            "HTRZ": `${row.HTRZ}`,
            "P": row.P ? `${parseFloat(row.P).toExponential(2)}<br/>` : 'N/A',
            "OR": row.OR ? `${parseFloat(row.OR).toFixed(2)}<br/>` : 'N/A',
            "GWAS_P": row.GWAS_P ? `${parseFloat(row.GWAS_P).toExponential(2)}<br/>` : 'N/A',
            "GWAS_OR": row.GWAS_OR ? `${parseFloat(row.GWAS_OR).toFixed(2)}<br/>` : 'N/A'
        }));

        // Define column order to match variant.html style
        const columnDefinitions = [
            { data: "Variant", title: "Variant" },
            { data: "Gene", title: "Gene" },
            { data: "AA_Change", title: "AA Change" },
            { data: "HMM_Score", title: "HMM Score" },
            { data: "P", title: "PheWAS P" },
            { data: "OR", title: "PheWAS OR" },
            { data: "GWAS_P", title: "GWAS P" },
            { data: "GWAS_OR", title: "GWAS OR" },
            { data: "Counts", title: "Cases<br/>Controls" },
            { data: "RefAF", title: "Ref AF" },
            { data: "AltAF", title: "Alt AF" },
            { data: "Ref_HMOZ", title: "Ref HMOZ" },
            { data: "Alt_HMOZ", title: "Alt HMOZ" },
            { data: "HTRZ", title: "HTRZ" }
        ];

        // Initialize DataTable with consistent options
        $('#resultsTable').DataTable({
            data: formattedData,
            columns: columnDefinitions,
            order: [[3, 'asc']],  // Order by PheWAS P-value
            responsive: true,
            autoWidth: false,
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'colvis',
                    text: 'Select Columns',
                    columns: ':not(:first-child)'
                }
            ],
            columnDefs: [
                {
                    targets: 0,  // Variant column
                    render: function (data, type, row) {
                        if (type === 'display') {
                            return `<a href="/variant/${data}" target="_blank">${data}</a>`;
                        }
                        return data;
                    }
                }
            ]
        });
    }

    const phecode = "{{ phecode }}";
    const term = "{{ term }}";

    // Function to load Table 1
    function loadTable1() {
        const encodedTerm = encodeURIComponent(term);
        fetch(`/phecode/${phecode}/term/${encodedTerm}/tableVar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ exampleKey: "exampleValue" }) // Add if the server requires a body
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(resultData => {
                renderDataTable(resultData.data, resultData.columns, resultData.defaultColumns, resultData.numColumns);
            })
            .catch(error => {
                console.error('Error loading Table 1:', error);
                alert('Failed to load table data. Check console for details.');
            });
    }

    function loadTable2() {
        const encodedTerm = encodeURIComponent(term);
        fetch(`/phecode/${phecode}/term/${encodedTerm}/tableGene`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ exampleKey: "exampleValue" }) // Add if the server requires a body
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(resultData => {
                renderDataTable(resultData.data, resultData.columns, resultData.defaultColumns, resultData.numColumns);
            })
            .catch(error => {
                console.error('Error loading Table 2:', error);
                alert('Failed to load table data. Check console for details.');
            });
    }

    function loadVariantDetailTable() {
        const encodedTerm = encodeURIComponent("{{ term }}");
        fetch(`/phecode/{{ phecode }}/term/${encodedTerm}/tableVariantDetail`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        })
            .then(response => response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.error || 'Error fetching data');
                }
                return data;
            }))
            .then(resultData => {
                renderDataTable(resultData.data, resultData.columns, resultData.defaultColumns, resultData.numColumns);
            })
            .catch(error => {
                console.error('Error loading Variant Detail Table:', error);
                alert('Failed to load table data: ' + error.message);
            });
    }

</script>
{% endblock %}