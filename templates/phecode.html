{% extends "data_base.html" %}

{% block title %}{{ data.phecode }} PheCode{% endblock %}

{% block content %}

{% include 'partials/phecode_details.html' %}

<!-- Centered spinner -->
<div id="nomalySpinner" class="d-flex justify-content-center align-items-center my-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Nomaly result display -->

<!--
<button id="nomalyButton" class="btn btn-success mb-3"> Nomaly Prioritised Terms </button>
-->

<div id="NomalyResultContainer" style="display: none;">
    <div id="nomalyResult" class="mt-3"></div>

    <!-- Div for QQplot -->
    <div id="plotContainer" style="width: 80%; height: 450px;"></div>

    <div id="testnumbers">
        <!-- Test numbers will be populated here -->
    </div>

    <h4>Per Term Nomaly Results</h4>
    <!-- Div for DataTable -->
    <div id="tableContainer" class="mb-4">
        <table id="resultsTable" class="table table-striped table-bordered" style="width: 100%; font-size: 0.85rem;">
        </table>
    </div>
</div>

<p></p>

<!-- Button to run the background task -->
{% if data.show_gwas %}
<button id="runTaskButton" class="btn btn-primary">GWAS Task</button>

<!-- Result display area -->
<div id="taskResult" class="mt-3"></div>
<br>

<div id="GWASTableContainer" style="display: none;">
    <h4>Per Variant GWAS Results</h4>
    <table id="variantTable" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Variant</th>
                <th>Gene</th>
                <th>RSID</th>
                <th>F_A</th>
                <th>F_U</th>
                <th>OR</th>
                <th>P</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ super() }} {# Include parent block's JS #}
<script>
        // At the top of your script block
        console.log('Plotly status at page load:', typeof Plotly !== 'undefined' ? 'Loaded' : 'Not loaded');

    // Define phecode and runbatch from template data
    const phecode = "{{ data.phecode }}";
    const runbatch = "{{ data.runbatch }}";

        // Function to create the Plotly graph directly
        function renderPlot(plotData) {
            console.log('Creating Plotly graph');
        $('#NomalyResultContainer').show();

        // Check if Plotly is available
        if (typeof Plotly === 'undefined') {
            console.warn('Plotly not found, loading it now...');

            // Create a script element to load Plotly
            const script = document.createElement('script');
            script.src = 'https://cdn.plot.ly/plotly-latest.min.js';

            // When the script loads, try rendering again
            script.onload = function () {
                console.log('Plotly loaded successfully, now rendering');
                actuallyRenderPlot(plotData);
            };

            script.onerror = function () {
                console.error('Failed to load Plotly');
                document.getElementById('plotContainer').innerHTML =
                    '<div class="alert alert-danger">Failed to load Plotly library</div>';
            };

            // Add the script to the document
            document.head.appendChild(script);
        } else {
            // Plotly is already available, render immediately
            console.log('Plotly already loaded, rendering directly');
            actuallyRenderPlot(plotData);
        }
    }

    // Actual rendering function
    function actuallyRenderPlot(plotData) {
        try {
            // Add more detailed error handling
            if (!plotData || plotData === "undefined" || plotData === "null") {
                console.error('Empty plot data received');
                document.getElementById('plotContainer').innerHTML =
                    '<div class="alert alert-warning">Unable to generate plot. Check server logs for details.</div>';
                return;
            }

            console.log('Plot data type:', typeof plotData);

            // Parse the JSON data
            const figureData = JSON.parse(plotData);

            console.log('Figure data parsed successfully');

            // Check if there's actual data
            if (!figureData.data || figureData.data.length === 0) {
                document.getElementById('plotContainer').innerHTML =
                    '<div class="alert alert-info">No data available for plotting.</div>';
                return;
            }

            // Create the plot directly
            Plotly.newPlot('plotContainer', figureData.data, figureData.layout, figureData.config)
                .then(() => {
                    console.log('Plot created successfully');
                    // Add event listeners
                    const plotElement = document.getElementById('plotContainer');

                    plotElement.on('plotly_click', function (data) {
                        console.log('Plot clicked:', data);
                        // Handle click events
                        if (data.points && data.points.length > 0) {
                            const term = data.points[0].text || data.points[0].customdata?.[0];
                            console.log('Clicked on term:', term);

                            // Only search if we have a valid term
                            if (term) {
                                const table = $('#resultsTable').DataTable();
                                table.search(term).draw();
                            }
                        }
                    });
                })
                .catch(err => {
                    console.error('Error creating plot:', err);
                    document.getElementById('plotContainer').innerHTML =
                        `<div class="alert alert-danger">Error creating plot: ${err.message}</div>`;
                });
        } catch (error) {
            console.error('Error parsing plot data:', error);
            console.log('First 100 chars of plot data:', plotData.substring(0, 100));
            document.getElementById('plotContainer').innerHTML =
                `<div class="alert alert-danger">Error parsing plot data: ${error.message}</div>`;
        }
    }

    // Function to populate the test numbers
    function populateTestNumbers(testnumbers) {
        console.log('Populating test numbers:', testnumbers);
        const testnumbersDiv = document.getElementById('testnumbers');
        testnumbersDiv.innerHTML = testnumbers;
    }

    // Function to initialize the DataTable
    function renderDataTable(resultData, columns, defaultColumns, numColumns) {
        console.log('Available columns:', columns); // Debug log

        // Create column definitions that match DataTables format
        const columnDefs = columns.map((col, index) => ({
            title: `<span title="${resultData.columnTooltips[index]}">${resultData.columnNames[index]}</span>`,
            data: col,
            name: col,
            visible: defaultColumns.includes(col),
            className: col.includes('pvalue') ? 'dt-right' : ''
        }));

        // Find column indices for sorting
        const minRankIndex = columns.findIndex(col => col === 'minrank');
        const mwuPIndex = columns.findIndex(col => col === 'mwu_pvalue');

        // Custom sorting function for P-values
        $.fn.dataTable.ext.type.order['p-value-pre'] = function (data) {
            if (data === null || data === '' || isNaN(data)) {
                return 1e99;
            }
            return parseFloat(data);
        };

        // Initialize DataTable with the correct options
        $('#resultsTable').DataTable({
            data: resultData.data,
            columns: columnDefs,
            order: [
                [minRankIndex, 'asc'],
                [mwuPIndex, 'asc']
            ],
            responsive: true,
            autoWidth: true,
            pageLength: 25,
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'colvis',
                    text: 'Select Columns',
                    columns: ':not(:first-child)'
                },
                {
                    extend: 'copy',
                    text: 'Copy'
                },
                {
                    extend: 'csv',
                    text: 'TSV',
                    fieldSeparator: '\t',
                    extension: '.tsv',
                    filename: function () {
                        return `phecode_stats_${phecode}`;
                    }
                },
                {
                    extend: 'excel',
                    text: 'Excel'
                }
            ]
        });
    }

    // Refactored Function to load Nomaly data using async/await
    async function loadNomalyData() {
        console.log('Starting load - showing spinner');
        $('#nomalySpinner').show();
        $('#NomalyResultContainer').hide();

        const endpoint = runbatch === "Run v1" ? `/nomaly-stats/${phecode}` : `/nomaly-stats2/${phecode}`;
        console.log('Fetching data from:', endpoint);

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            console.log('Received response');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const resultData = await response.json();
            console.log('Data received, rendering content');

            // Use plotData instead of qqplot
            if (resultData.plotData) {
                renderPlot(resultData.plotData);
            } else {
                console.error('No plot data found in response');
            }

            renderDataTable(resultData, resultData.columns, resultData.defaultColumns, resultData.numColumns);
            console.log('Content rendered');
        } catch (error) {
            console.error('Error occurred:', error);
            const resultDiv = document.getElementById('nomalyResult');
            resultDiv.innerHTML = `Error: ${error.message}`;
        } finally {
            console.log('Attempting to hide the spinner and show the result container.');

            const spinner = document.getElementById('nomalySpinner');
            const resultContainer = document.getElementById('NomalyResultContainer');

            if (spinner) {
                console.log('Spinner found:', spinner);
                spinner.style.display = 'none';
                spinner.style.visibility = 'hidden';
                spinner.classList.remove('d-flex');
                spinner.classList.add('d-none');
                console.log('Spinner display set to none.');
            } else {
                console.error('Spinner element not found.');
            }

            if (resultContainer) {
                console.log('Result container found:', resultContainer);
                resultContainer.style.display = 'block';
                resultContainer.classList.remove('d-none');
                console.log('Result container display set to block.');
            } else {
                console.error('Result container element not found.');
            }
        }
    }

    // Initialize data load on document ready
                            $(document).ready(function () {
                            console.log('Document ready, Plotly available:', typeof Plotly !== 'undefined');

                            // Add a Plotly check before calling loadNomalyData
                            if (typeof Plotly === 'undefined') {
                                console.warn('Plotly not loaded at document ready');
                            }
                        
        loadNomalyData();

        // Conditional Event Listener Attachment
        const runTaskButton = document.getElementById('runTaskButton');
        if (runTaskButton) {
            runTaskButton.addEventListener('click', function () {
                const resultDiv = document.getElementById('taskResult');
                console.log('GWAS Task button clicked');

                fetch(`/run-task/${phecode}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Received response:', data);  // Debug log
                        if (data.status === "completed") {
                            resultDiv.innerHTML = `Result: ${data.result}`;
                            if (data.associations && data.associations.length > 0) {
                                console.log(`Found ${data.associations.length} associations`);  // Debug log
                                populateTable(data.associations);
                            } else {
                                console.log('No associations found in data');  // Debug log
                                resultDiv.innerHTML += '<br>No significant associations found.';
                            }
                        } else {
                            resultDiv.innerHTML = `Failed: ${data.result}`;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('taskResult').innerHTML = `Error: ${error.message}`;
                    });
            });
        }
    });

    // Function to populate the GWAS table
    function populateTable(data) {
        console.log('Populating GWAS table with data:', data);  // Debug log
        $('#GWASTableContainer').show();

        if ($.fn.DataTable.isDataTable('#variantTable')) {
            $('#variantTable').DataTable().destroy();  // Clean up existing table
        }

        try {
            $('#variantTable').DataTable({
                data: data,
                columns: [
                    {
                        data: 'Variant',
                        render: function (data, type, row) {
                            if (type === 'display' && data) {
                                return variantUtils.createLink(data);
                            }
                            return data || '';
                        }
                    },
                    {
                        data: 'Gene',
                        render: function (data) { return data || ''; }
                    },
                    {
                        data: 'RSID',
                        render: function (data) { return data || ''; }
                    },
                    {
                        data: 'F_A',
                        render: function (data) { return data || ''; }
                    },
                    {
                        data: 'F_U',
                        render: function (data) { return data || ''; }
                    },
                    {
                        data: 'OR',
                        render: function (data) { return data || ''; }
                    },
                    {
                        data: 'P',
                        render: function (data) { return data || ''; }
                    }
                ],
                order: [[6, 'asc']],
                pageLength: 25,
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'colvis',
                        text: 'Select Columns',
                        columns: ':not(:first-child)'
                    },
                    {
                        extend: 'copy',
                        text: 'Copy'
                    },
                    {
                        extend: 'csv',
                        text: 'TSV',
                        fieldSeparator: '\t',
                        extension: '.tsv',
                        filename: function () {
                            return `phecode_gwas_${phecode}`;
                        }
                    },
                    {
                        extend: 'excel',
                        text: 'Excel'
                    }
                ]
            });
            console.log('Table initialized successfully');  // Debug log
        } catch (error) {
            console.error('Error initializing table:', error);  // Error log
        }
    }
</script>
{% endblock %}