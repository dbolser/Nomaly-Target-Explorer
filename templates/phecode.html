{% extends "data_base.html" %}

{% block title %}{{ data.phecode }} PheCode{% endblock %}

{% block content %}
<h3>{{data.description}}</h3>

<div id="phecodeDetails" class="mb-4">
    <p class="p-2 bg-light rounded">
        <span>Phecode: {{ data.phecode }} ({{data.runbatch}})</span> |
        <span>Sex: {{ data.sex }}</span> |
        <span>Affected: <strong>{{ data.affected }}</strong></span> |
        <span>Excluded: {{ data.excluded }} ({{ data.phecode_exclude }})</span> |
        <span>Disease: {{ data.phecode_group }}</span>
    </p>
    <ul class="meaning-list">
        {% for meaning in data.meaning %}
        <li>{{ meaning }}</li>
        {% endfor %}
    </ul>
</div>

<!-- Nomaly result display -->
<!-- <h3> Prioritised terms </h3> -->

<button id="nomalyButton" class="btn btn-success mb-3"> Nomaly Prioritised Terms </button>

<div id="NomalyResultContainer" style="display: none;">
    <div id="nomalyResult" class="mt-3"></div>

    <!-- Div for QQplot -->
    <iframe id="plotIframe" style="width: 80%; height: 450px; border: none;"></iframe>

    <div id="testnumbers">
        <!-- Test numbers will be populated here -->
    </div>

    <!-- Div for DataTable -->
    <div id="tableContainer" class="mb-4">
        <table id="resultsTable" class="table table-striped table-bordered" style="width: 100%; font-size: 0.85rem;">
        </table>
    </div>
</div>

<p></p>

<!-- Button to run the background task -->
<button id="runTaskButton" class="btn btn-primary">GWAS Task</button>

<!-- Result display area -->
<div id="taskResult" class="mt-3"></div>
<br>

<div id="GWAStableContainer" style="display: none;">
    <h4>Variant level view</h4>
    <table id="variantTable" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Variant</th>
                <th>Gene</th>
                <th>RSID</th>
                <th>F_A</th>
                <th>F_U</th>
                <th>OR</th>
                <th>P</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }} {# Include parent block's JS #}
<script>
    // Function to render the Plotly graph
    function renderPlot(graphHtml) {
        $('#NomalyResultContainer').show();
        const iframe = document.getElementById('plotIframe');
        iframe.srcdoc = graphHtml;
    }

    // Function to populate the test numbers
    function populateTestNumbers(testnumbers) {
        const testnumbersDiv = document.getElementById('testnumbers');
        testnumbersDiv.innerHTML = testnumbers;
    }

    // Function to initialize the DataTable
    function renderDataTable(data, columns, defaultColumns, numColumns) {
        // Destroy existing table if it exists
        if ($.fn.DataTable.isDataTable('#resultsTable')) {
            $('#resultsTable').DataTable().destroy();
        }

        // Initialize DataTable with dynamic columns
        $('#resultsTable').DataTable({
            data: data,
            columns: columns.map(col => ({
                title: col,
                data: col,
                visible: defaultColumns.includes(col),  // Show default columns initially
                render: function (data, type, row) {
                    // Client-side formatting for specific columns
                    if (numColumns.includes(col) && type === 'display') {
                        // Check if the value is a number before formatting
                        if (!isNaN(parseFloat(data))) {
                            return parseFloat(data).toExponential(2); // Format as scientific notation with 2 decimal places
                        }
                    }
                    return data;
                }
            })),
            order: [[0, 'asc']],
            responsive: true,
            autoWidth: true,
            dom: 'Bfrtip',  // Include buttons for column visibility
            buttons: [
                {
                    extend: 'colvis',
                    text: 'Select Columns',
                    columns: ':not(:first-child)'  // Allow toggling for all columns except the first
                }
            ]
        });
    }

    // Event listener for the button click Nomaly detail Uncomment below to use the button
    document.getElementById('nomalyButton').addEventListener('click', function () {
        const phecode = "{{ data.phecode }}";
        const runbatch = "{{ data.runbatch }}";

        const resultDiv = document.getElementById('nomalyResult');

        // Send a POST request to get the Nomaly result
        if (runbatch == "Run v1") {
            fetch(`/nomaly-stats/${phecode}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => response.json())
                .then(resultData => {
                    // Render Plotly graph
                    renderPlot(resultData.qqplot);
                    // resultDiv.innerHTML = `${resultData.statstype}`;
                    populateTestNumbers("Tested affected: " + resultData.affected + " Tested control: " + resultData.control);
                    // Render DataTable
                    renderDataTable(resultData.data, resultData.columns, resultData.defaultColumns, resultData.numColumns);
                }).catch(error => {
                    resultDiv.innerHTML = `Error: ${error.message}`;
                });
        } else if (runbatch == "Run v2") {
            fetch(`/nomaly-stats2/${phecode}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => response.json())
                .then(resultData => {
                    renderPlot(resultData.qqplot);
                    renderDataTable(resultData.data, resultData.columns, resultData.defaultColumns, resultData.numColumns);
                }).catch(error => {
                    resultDiv.innerHTML = `Error: ${error.message}`;
                });
        }
    });

    // Event listener for the button click GWAS task
    document.getElementById('runTaskButton').addEventListener('click', function () {
        const resultDiv = document.getElementById('taskResult');

        // Send a POST request to start the background task
        fetch(`/run-task/${phecode}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "Task started") {
                    resultDiv.innerHTML = "Task started. Please wait...";

                    // Poll the server for the result
                    const checkResult = setInterval(() => {
                        fetch(`/task-result/${phecode}`)
                            .then(response => response.json())
                            .then(resultData => {
                                if (resultData.result.includes("Failed")) {
                                    resultDiv.innerHTML = `Failed: ${resultData.result}`;
                                    clearInterval(checkResult);
                                } else if (!resultData.result.includes("Processing...")) {
                                    resultDiv.innerHTML = `Result: ${resultData.result}`;
                                    clearInterval(checkResult);
                                    // populate the table with the result
                                    populateTable(resultData.associations);
                                }
                            });
                    }, 1000);
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `Error: ${error.message}`;
            });
    });

    // Function to populate the GWAS table
    function populateTable(data) {
        // Show the table container
        $('#GWAStableContainer').show();

        // Initialize DataTable if not already initialized
        if (!$.fn.DataTable.isDataTable('#variantTable')) {
            $('#variantTable').DataTable({
                data: data,
                columns: [
                    {
                        data: 'Variant',
                        render: function (data, type, row) {
                            if (type === 'display') {
                                // Format variant string: "5:33951588_C/G" -> "5_33951588_C_G"
                                const formattedVariant = data
                                    .replace(':', '_')
                                    .replace('/', '_');
                                return `<a href="/variant/${formattedVariant}" target="_blank">${data}</a>`;
                            }
                            return data;
                        }
                    },
                    { data: 'Gene', searchable: true },
                    { data: 'RSID' },
                    { data: 'F_A' },
                    { data: 'F_U' },
                    { data: 'OR', orderable: true },
                    { data: 'P', orderable: true }
                ],
                order: [[6, 'asc']] // Default ordering by 'P' column
            });
        }
    }
</script>
{% endblock %}