<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ data.phecode }} PheCode</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <!-- Bootstrap JS, DataTables JS, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

</head>

<body>
    <div class="container mt-4">
        <h3>{{data.description}}</h3>
                        
        <div id="phecodeDetails" class="mb-4">
            <p class="p-2 bg-light rounded">
                <span><a href="/phecode/{{ data.phecode }}" target="_blank">Phecode: {{ data.phecode }}</a></span> |
                <span>Sex: {{ data.sex }}</span> |
                <span>Affected: <strong>{{ data.affected }}</strong></span> |
                <span>Excluded: {{ data.excluded }} ({{ data.phecode_exclude }})</span> |
                <span>Disease: {{ data.phecode_group }}</span>
            </p>
            <ul class="meaning-list">
                {% for meaning in data.meaning %}
                    <li>{{ meaning }}</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Nomaly result display -->

        <!-- Button to run the background task -->
        <button id="runTaskButton" class="btn btn-primary">GWAS Task</button>

        <!-- Result display area -->
        <div id="taskResult" class="mt-3"></div>
        <br>

        <div id="GWAStableContainer" style="display: none;">
            <h4>Variant level view</h4>
            <table id="variantTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Variant</th>
                        <th>Gene</th>
                        <th>RSID</th>
                        <th>F_A</th>
                        <th>F_U</th>
                        <th>OR</th>
                        <th>P</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
    </div>

    <script>
        // Event listener for the button click GWAS task
        document.getElementById('runTaskButton').addEventListener('click', function() {
            const phecode = "{{ data.phecode }}";
            const resultDiv = document.getElementById('taskResult');

            // Send a POST request to start the background task
            fetch(`/run-task/${phecode}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "Task started") {
                    resultDiv.innerHTML = "Task started. Please wait...";

                    // Poll the server for the result
                    const checkResult = setInterval(() => {
                        fetch(`/task-result/${phecode}`)
                        .then(response => response.json())
                        .then(resultData => {
                            if (resultData.result.includes("Failed")) {
                                resultDiv.innerHTML = `Failed: ${resultData.result}`;
                                clearInterval(checkResult);
                            } else
                            if (!resultData.result.includes("Processing...")) {
                                resultDiv.innerHTML = `Result: ${resultData.result}`;
                                clearInterval(checkResult);
                                // populate the table with the result
                                populateTable(resultData.associations);
                            }
                        });
                    }, 1000);
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `Error: ${error.message}`;
            });
        });

        // Function to populate the GWAS table
        function populateTable(data) {
            // Show the table container
            $('#GWAStableContainer').show();

            // Initialize DataTable if not already initialized
            if (!$.fn.dataTable.isDataTable('#variantTable')) {
                $('#variantTable').DataTable({
                    data: data,
                    columns: [
                        { data: 'Variant' },
                        { data: 'Gene', searchable: true },
                        { data: 'RSID' },
                        { data: 'F_A' },
                        { data: 'F_U' },
                        { data: 'OR', orderable: true },
                        { data: 'P', orderable: true }
                    ],
                    order: [[6, 'asc']] // Default ordering by 'P' column
                });
            }
        }
    </script>

</body>
</html>