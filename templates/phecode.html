<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ data.phecode }} PheCode</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

    <!-- Bootstrap JS, DataTables JS, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.plotly.com/plotly-latest.min.js"></script>

    <!-- DataTables extensions for buttons and column visibility -->
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.colVis.min.js"></script>

</head>

<body>
    <div class="container mt-4">
        <h3>{{data.description}}</h3>
                        
        <div id="phecodeDetails" class="mb-4">
            <p class="p-2 bg-light rounded">
                <span><a href="/phecode/{{ data.phecode }}" target="_blank">Phecode: {{ data.phecode }}</a></span> |
                <span>Sex: {{ data.sex }}</span> |
                <span>Affected: <strong>{{ data.affected }}</strong></span> |
                <span>Excluded: {{ data.excluded }} ({{ data.phecode_exclude }})</span> |
                <span>Disease: {{ data.phecode_group }}</span>
            </p>
            <ul class="meaning-list">
                {% for meaning in data.meaning %}
                    <li>{{ meaning }}</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Nomaly result display -->

        <button id="nomalyButton" class="btn btn-success mb-3">Load Nomaly Results</button>

        <div id="NomalyResultContainer" style="display: none;">
            <div id="nomalyResult" class="mt-3"></div>

            <iframe id="plotIframe" style="width: 50%; height: 450px; border: none;"></iframe>
            <!-- Div for Plotly Graph -->
            <!-- <div id="plotContainer" class="mb-4"></div> -->

            <!-- Div for DataTable -->
            <style>
                #resultsTable {
                    font-size: 0.85rem;  /* Adjust the size as needed */
                }
            </style>
            <div id="tableContainer" class="mb-4">
                <table id="resultsTable" class="table table-striped table-bordered" style="width: 100%;"></table>
            </div>

        </div>

        <p></p>

        <!-- Button to run the background task -->
        <button id="runTaskButton" class="btn btn-primary">GWAS Task</button>

        <!-- Result display area -->
        <div id="taskResult" class="mt-3"></div>
        <br>

        <div id="GWAStableContainer" style="display: none;">
            <h4>Variant level view</h4>
            <table id="variantTable" class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Variant</th>
                        <th>Gene</th>
                        <th>RSID</th>
                        <th>F_A</th>
                        <th>F_U</th>
                        <th>OR</th>
                        <th>P</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
    </div>

    <script>
        // Function to render the Plotly graph
        function renderPlot(graphHtml) {
            $('#NomalyResultContainer').show();
            const iframe = document.getElementById('plotIframe');
            iframe.srcdoc = graphHtml;
        }

        // Function to initialize the DataTable
        function renderDataTable(data, columns, defaultColumns, numColumns) {
            // Destroy existing table if it exists
            if ($.fn.DataTable.isDataTable('#resultsTable')) {
                $('#resultsTable').DataTable().destroy();
            }

            // Initialize DataTable with dynamic columns
            $('#resultsTable').DataTable({
                data: data,
                columns: columns.map(col => ({ 
                    title: col, data: col,
                    visible: defaultColumns.includes(col),  // Show default columns initially
                    render: function (data, type, row) {
            // Client-side formatting for specific columns
            if (numColumns.includes(col) && type === 'display') {
                // Check if the value is a number before formatting
                if (!isNaN(parseFloat(data))) {
                    return parseFloat(data).toExponential(2); // Format as scientific notation with 3 decimal places
                }
            }
            return data;
        }
                })),
                order: [[0, 'asc']],
                responsive: true,
                autoWidth: true,
                dom: 'Bfrtip',  // Include buttons for column visibility
                buttons: [
                    {
                        extend: 'colvis',
                        text: 'Select Columns',
                        columns: ':not(:first-child)'  // Allow toggling for all columns except the first
                    }
                ]
            });
        }
        // Event listener for the button click Nomaly detail
        document.getElementById('nomalyButton').addEventListener('click', function() {
            const phecode = "{{ data.phecode }}";
            
            const resultDiv = document.getElementById('nomalyResult');

            // Send a POST request to get the Nomaly result
            fetch(`/nomaly-stats/${phecode}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => response.json())
            .then(resultData =>{
                // Render Plotly graph
                renderPlot(resultData.qqplot);
                // resultDiv.innerHTML = `${resultData.statstype}`;
                // Render DataTable
                renderDataTable(resultData.data, resultData.columns, resultData.defaultColumns, resultData.numColumns);
            }).catch(error => {
                resultDiv.innerHTML = `Error: ${error.message}`;
            });
        });

        // Event listener for the button click GWAS task
        document.getElementById('runTaskButton').addEventListener('click', function() {
            const phecode = "{{ data.phecode }}";
            const resultDiv = document.getElementById('taskResult');

            // Send a POST request to start the background task
            fetch(`/run-task/${phecode}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "Task started") {
                    resultDiv.innerHTML = "Task started. Please wait...";

                    // Poll the server for the result
                    const checkResult = setInterval(() => {
                        fetch(`/task-result/${phecode}`)
                        .then(response => response.json())
                        .then(resultData => {
                            if (resultData.result.includes("Failed")) {
                                resultDiv.innerHTML = `Failed: ${resultData.result}`;
                                clearInterval(checkResult);
                            } else
                            if (!resultData.result.includes("Processing...")) {
                                resultDiv.innerHTML = `Result: ${resultData.result}`;
                                clearInterval(checkResult);
                                // populate the table with the result
                                populateTable(resultData.associations);
                            }
                        });
                    }, 1000);
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `Error: ${error.message}`;
            });
        });

        // Function to populate the GWAS table
        function populateTable(data) {
            // Show the table container
            $('#GWAStableContainer').show();

            // Initialize DataTable if not already initialized
            if (!$.fn.dataTable.isDataTable('#variantTable')) {
                $('#variantTable').DataTable({
                    data: data,
                    columns: [
                        { data: 'Variant' },
                        { data: 'Gene', searchable: true },
                        { data: 'RSID' },
                        { data: 'F_A' },
                        { data: 'F_U' },
                        { data: 'OR', orderable: true },
                        { data: 'P', orderable: true }
                    ],
                    order: [[6, 'asc']] // Default ordering by 'P' column
                });
            }
        }
    </script>

</body>
</html>