{% extends "data_base.html" %}

{% block title %}{{ data.phecode }} PheCode{% endblock %}

{% block content %}
<h3>{{data.description}}</h3>

<div id="phecodeDetails" class="mb-4">
    <p class="p-2 bg-light rounded">
        <span>Phecode: {{ data.phecode }} ({{data.runbatch}})</span> |
        <span>Sex: {{ data.sex }}</span> |
        <span>Affected: <strong>{{ data.affected }}</strong></span> |
        <span>Control: {{ data.control }} </span> |
        <span>Excluded: {{ data.excluded }} ({{ data.phecode_exclude }})</span> |
        <span>Disease: {{ data.phecode_group }}</span>
    </p>
    <ul class="meaning-list">
        {% for meaning in data.meaning %}
        <li>{{ meaning }}</li>
        {% endfor %}
    </ul>
</div>

<!-- Centered spinner -->
<div id="nomalySpinner" class="d-flex justify-content-center align-items-center my-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Nomaly result display -->

<!--
<button id="nomalyButton" class="btn btn-success mb-3"> Nomaly Prioritised Terms </button>
-->

<div id="NomalyResultContainer" style="display: none;">
    <div id="nomalyResult" class="mt-3"></div>

    <!-- Div for QQplot -->
    <iframe id="plotIframe" style="width: 80%; height: 450px; border: none;"></iframe>

    <div id="testnumbers">
        <!-- Test numbers will be populated here -->
    </div>

    <h4>Per Term Nomaly Results</h4>
    <!-- Div for DataTable -->
    <div id="tableContainer" class="mb-4">
        <table id="resultsTable" class="table table-striped table-bordered" style="width: 100%; font-size: 0.85rem;">
        </table>
    </div>
</div>

<p></p>

<!-- Button to run the background task -->
{% if data.show_gwas %}
<button id="runTaskButton" class="btn btn-primary">GWAS Task</button>

<!-- Result display area -->
<div id="taskResult" class="mt-3"></div>
<br>

<div id="GWAStableContainer" style="display: none;">
    <h4>Per Variant GWAS Results</h4>
    <table id="variantTable" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Variant</th>
                <th>Gene</th>
                <th>RSID</th>
                <th>F_A</th>
                <th>F_U</th>
                <th>OR</th>
                <th>P</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{{ super() }} {# Include parent block's JS #}
<script>
    // Define phecode and runbatch from template data
    const phecode = "{{ data.phecode }}";
    const runbatch = "{{ data.runbatch }}";

    // Function to render the Plotly graph
    function renderPlot(graphHtml) {
        console.log('Rendering Plotly graph');
        $('#NomalyResultContainer').show();
        const iframe = document.getElementById('plotIframe');
        iframe.srcdoc = graphHtml;
    }

    // Function to populate the test numbers
    function populateTestNumbers(testnumbers) {
        console.log('Populating test numbers:', testnumbers);
        const testnumbersDiv = document.getElementById('testnumbers');
        testnumbersDiv.innerHTML = testnumbers;
    }

    // Function to initialize the DataTable
    function renderDataTable(resultData, columns, defaultColumns, numColumns) {
        console.log('Available columns:', columns); // Debug log

        if ($.fn.DataTable.isDataTable('#resultsTable')) {
            $('#resultsTable').DataTable().destroy();
        }

        // Find column indices for sorting
        const minRankIndex = columns.findIndex(col => col === 'minrank'); // Changed from 'minrank'
        const mwuPIndex = columns.findIndex(col => col === 'mwu_pvalue');

        console.log('Found indices:', { minRankIndex, mwuPIndex }); // Debug log

        // Custom sorting function for P-values
        $.fn.dataTable.ext.type.order['p-value-pre'] = function (data) {
            if (data === null || data === '' || isNaN(data)) {
                return 1e99;
            }
            return parseFloat(data);
        };

        $('#resultsTable').DataTable({
            data: resultData.data,
            columns: columns.map((col, index) => ({
                title: `<span title="${resultData.columnTooltips[index]}">${resultData.columnNames[index]}</span>`,
                data: col,
                visible: defaultColumns.includes(col),
                className: col.includes('pvalue') ? 'dt-right' : '',
                type: col === 'MWU P-value' ? 'p-value' : null
            })),
            order: [
                [minRankIndex, 'asc'],
                [mwuPIndex, 'asc']
            ],
            responsive: true,
            autoWidth: true,
            pageLength: 25,
            dom: 'lBfrtip',
            buttons: [
                {
                    extend: 'colvis',
                    text: 'Select Columns',
                    columns: ':not(:first-child)'
                }
            ]
        });
    }

    // Refactored Function to load Nomaly data using async/await
    async function loadNomalyData() {
        console.log('Starting load - showing spinner');
        $('#nomalySpinner').show();
        $('#NomalyResultContainer').hide();

        const endpoint = runbatch === "Run v1" ? `/nomaly-stats/${phecode}` : `/nomaly-stats2/${phecode}`;
        console.log('Fetching data from:', endpoint);

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            console.log('Received response');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const resultData = await response.json();
            console.log('Data received, rendering content');
            renderPlot(resultData.qqplot);

            renderDataTable(resultData, resultData.columns, resultData.defaultColumns, resultData.numColumns);
            console.log('Content rendered');
        } catch (error) {
            console.error('Error occurred:', error);
            const resultDiv = document.getElementById('nomalyResult');
            resultDiv.innerHTML = `Error: ${error.message}`;
        } finally {
            console.log('Attempting to hide the spinner and show the result container.');

            const spinner = document.getElementById('nomalySpinner');
            const resultContainer = document.getElementById('NomalyResultContainer');

            if (spinner) {
                console.log('Spinner found:', spinner);
                spinner.style.display = 'none';
                spinner.style.visibility = 'hidden';
                spinner.classList.remove('d-flex');
                spinner.classList.add('d-none');
                console.log('Spinner display set to none.');
            } else {
                console.error('Spinner element not found.');
            }

            if (resultContainer) {
                console.log('Result container found:', resultContainer);
                resultContainer.style.display = 'block';
                resultContainer.classList.remove('d-none');
                console.log('Result container display set to block.');
            } else {
                console.error('Result container element not found.');
            }
        }
    }

    // Initialize data load on document ready
    $(document).ready(function () {
        console.log('Document ready, calling loadNomalyData');
        loadNomalyData();

        // Conditional Event Listener Attachment
        const runTaskButton = document.getElementById('runTaskButton');
        if (runTaskButton) {
            runTaskButton.addEventListener('click', function () {
                const resultDiv = document.getElementById('taskResult');
                console.log('GWAS Task button clicked');

                fetch(`/run-task/${phecode}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Received response:', data);  // Debug log
                        if (data.status === "completed") {
                            resultDiv.innerHTML = `Result: ${data.result}`;
                            if (data.associations && data.associations.length > 0) {
                                console.log(`Found ${data.associations.length} associations`);  // Debug log
                                populateTable(data.associations);
                            } else {
                                console.log('No associations found in data');  // Debug log
                                resultDiv.innerHTML += '<br>No significant associations found.';
                            }
                        } else {
                            resultDiv.innerHTML = `Failed: ${data.result}`;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('taskResult').innerHTML = `Error: ${error.message}`;
                    });
            });
        }
    });

    // Function to populate the GWAS table
    function populateTable(data) {
        console.log('Populating GWAS table with data:', data);  // Debug log
        $('#GWAStableContainer').show();

        if ($.fn.DataTable.isDataTable('#variantTable')) {
            $('#variantTable').DataTable().destroy();  // Clean up existing table
        }

        try {
            $('#variantTable').DataTable({
                data: data,
                columns: [
                    {
                        data: 'Variant',
                        render: function (data, type, row) {
                            if (type === 'display' && data) {
                                const formattedVariant = data.replace(':', '_').replace('/', '_');
                                return `<a href="/variant/${formattedVariant}" target="_blank">${data}</a>`;
                            }
                            return data || '';
                        }
                    },
                    {
                        data: 'Gene',
                        render: function (data) { return data || ''; }
                    },
                    {
                        data: 'RSID',
                        render: function (data) { return data || ''; }
                    },
                    {
                        data: 'F_A',
                        render: function (data) { return data || ''; }
                    },
                    {
                        data: 'F_U',
                        render: function (data) { return data || ''; }
                    },
                    {
                        data: 'OR',
                        render: function (data) { return data || ''; }
                    },
                    {
                        data: 'P',
                        render: function (data) { return data || ''; }
                    }
                ],
                order: [[6, 'asc']],
                pageLength: 25,
                dom: 'lBfrtip',
                buttons: ['copy', 'csv', 'excel']
            });
            console.log('Table initialized successfully');  // Debug log
        } catch (error) {
            console.error('Error initializing table:', error);  // Error log
        }
    }
</script>
{% endblock %}