{% extends "data_base.html" %}

{% block title %}Variant: {{ data.variant_id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>Variant Details</h3>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Basic Information</h5>
            <p class="card-text">
                <strong>Variant ID:</strong> {{ data.variant_id }}<br>
                <strong>Chromosome:</strong> {{ data.chromosome }}<br>
                <strong>Position:</strong> {{ data.position }}<br>
                <strong>Alleles:</strong> {{ data.alleles }}
            </p>
        </div>
    </div>

    <!-- Button to run PheWAS -->
    <button id="runPheWASButton" class="btn btn-primary">PheWAS Task</button>

    <!-- Result display area -->
    <div id="phewasResult" class="mt-3"></div>
    <br>

    <!-- PheWAS Results Table -->
    <div id="PheWASTableContainer" style="display: none;">
        <h4>PheWAS Results</h4>
        <table id="phewasTable" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Phecode</th>
                    <th>Description</th>
                    <th>Cases</th>
                    <th>Controls</th>
                    <th>OR</th>
                    <th>P</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Associated Phenotypes Section -->
    {% if data.phenotypes %}
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Associated Phenotypes</h5>
            <div class="table-responsive">
                <table id="phenotypesTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Phecode</th>
                            <th>Description</th>
                            <th>P-value</th>
                            <th>OR</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pheno in data.phenotypes %}
                        <tr>
                            <td><a href="/phecode/{{ pheno.phecode }}">{{ pheno.phecode }}</a></td>
                            <td>{{ pheno.description }}</td>
                            <td>{{ pheno.pvalue }}</td>
                            <td>{{ pheno.odds_ratio }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    $(document).ready(function() {
        // Event listener for the PheWAS button
        document.getElementById('runPheWASButton').addEventListener('click', function() {
            const resultDiv = document.getElementById('phewasResult');
            const variant = "{{ data.variant_id }}".replace(':', '_').replace('/', '_');

            // Get the current URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const flushParam = urlParams.get('flush') || '0';

            // Send a POST request to start the background task
            fetch(`/run-phewas/${variant}?flush=${flushParam}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "Task started") {
                    resultDiv.innerHTML = "PheWAS analysis started. Please wait...";

                    // Poll the server for the result
                    const checkResult = setInterval(() => {
                        fetch(`/phewas-result/${variant}`)
                        .then(response => response.json())
                        .then(resultData => {
                            console.log("Received result:", resultData); // Add debugging

                            if (resultData.result && resultData.result.includes("Failed")) {
                                resultDiv.innerHTML = `Failed: ${resultData.result}`;
                                clearInterval(checkResult);
                            } else if (resultData.result && !resultData.result.includes("Processing...")) {
                                resultDiv.innerHTML = resultData.result;

                                // Check if we have associations to display
                                if (resultData.associations && resultData.associations.length > 0) {
                                    populatePheWASTable(resultData.associations);
                                }

                                clearInterval(checkResult);
                            }
                        })
                            .catch(error => {
                                console.error("Error fetching results:", error);
                                resultDiv.innerHTML = `Error: ${error.message}`;
                                clearInterval(checkResult);
                        });
                    }, 1000);
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `Error: ${error.message}`;
            });
        });

        // Function to populate the PheWAS table
        function populatePheWASTable(data) {
            // Show the table container
            $('#PheWASTableContainer').show();

            // Initialize DataTable if not already initialized
            if (!$.fn.DataTable.isDataTable('#phewasTable')) {
                $('#phewasTable').DataTable({
                    data: data,
                    columns: [
                        { 
                            data: 'Phecode',
                            render: function(data, type, row) {
                                if (type === 'display') {
                                    return `<a href="/phecode/${data}" target="_blank">${data}</a>`;
                                }
                                return data;
                            }
                        },
                        { data: 'Description' },
                        { data: 'Cases' },
                        { data: 'Controls' },
                        { data: 'OR', orderable: true },
                        { 
                            data: 'P',
                            orderable: true,
                            render: function(data, type, row) {
                                if (type === 'display') {
                                    return parseFloat(data).toExponential(2);
                                }
                                return data;
                            }
                        }
                    ],
                    order: [[5, 'asc']] // Default ordering by P-value
                });
            }
        }
    });
</script>
{% endblock %}