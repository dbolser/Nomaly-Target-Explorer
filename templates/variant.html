{% extends "data_base.html" %}

{% block title %}Variant: {{ data.variant_id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3>Variant Details</h3>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Basic Information</h5>
            <p class="card-text">
                <strong>Variant ID:</strong> {{ data.variant_id }}<br>
                <strong>Chromosome:</strong> {{ data.chromosome }}<br>
                <strong>Position:</strong> {{ data.position }}<br>
                <strong>Alleles:</strong> {{ data.alleles }}
            </p>
        </div>
    </div>

    <!-- Button to run PheWAS -->
    <button id="runPheWASButton" class="btn btn-primary">PheWAS Task</button>

    <!-- Result display area -->
    <div id="phewasResult" class="mt-3"></div>
    <br>

    <!-- PheWAS Results Table -->
    <div id="phewasTableContainer" style="display: none;">
        <h4>PheWAS Results</h4>
        <div class="datatable-container">
            <!-- Table will be dynamically inserted here -->
        </div>
    </div>

    <!-- Associated Phenotypes Section -->
    {% if data.phenotypes %}
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Associated Phenotypes</h5>
            <div class="table-responsive">
                <table id="phenotypesTable" class="table table-striped">
                    <thead>
                        <tr>
                            <th>Phecode</th>
                            <th>Description</th>
                            <th>P-value</th>
                            <th>OR</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pheno in data.phenotypes %}
                        <tr>
                            <td><a href="/phecode/{{ pheno.phecode }}">{{ pheno.phecode }}</a></td>
                            <td>{{ pheno.description }}</td>
                            <td>{{ pheno.pvalue }}</td>
                            <td>{{ pheno.odds_ratio }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
    $(document).ready(function() {
        // Event listener for the PheWAS button
        document.getElementById('runPheWASButton').addEventListener('click', function() {
            const resultDiv = document.getElementById('phewasResult');
            const variant = "{{ data.variant_id }}".replace(':', '_').replace('/', '_');

            // Get the current URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const flushParam = urlParams.get('flush') || '0';

            // Send a POST request to start the background task
            fetch(`/run-phewas/${variant}?flush=${flushParam}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "Task started") {
                    resultDiv.innerHTML = "PheWAS analysis started. Please wait...";

                    // Poll the server for the result
                    const checkResult = setInterval(() => {
                        fetch(`/phewas-result/${variant}`)
                        .then(response => response.json())
                        .then(resultData => {
                            console.log("Received result:", resultData); // Add debugging

                            if (resultData.result && resultData.result.includes("Failed")) {
                                resultDiv.innerHTML = `Failed: ${resultData.result}`;
                                clearInterval(checkResult);
                            } else if (resultData.result && !resultData.result.includes("Processing...")) {
                                resultDiv.innerHTML = resultData.result;

                                // Check if we have associations to display
                                if (resultData.associations && resultData.associations.length > 0) {
                                    populatePheWASTable(resultData.associations);
                                }

                                clearInterval(checkResult);
                            }
                        })
                            .catch(error => {
                                console.error("Error fetching results:", error);
                                resultDiv.innerHTML = `Error: ${error.message}`;
                                clearInterval(checkResult);
                        });
                    }, 1000);
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `Error: ${error.message}`;
            });
        });

        // Function to populate the PheWAS table
        function populatePheWASTable(data) {
            if (!data || data.length === 0) {
                console.error('No data available to populate the table.');
                return;
            }

            // Define the desired column order and display names
            const columnDefinitions = [
                { data: "Phecode", title: "Phecode" },
                { data: "Sex", title: "Sex" },
                { data: "Description", title: "Description" },
                { data: "Group", title: "Group" },
                { data: "Cases", title: "Cases" },
                { data: "Controls", title: "Controls" },
                { data: "CasesRefAlt", title: "Cases (Alt/Ref)" },
                { data: "ControlsRefAlt", title: "Controls (Alt/Ref)" },
                { data: "OR", title: "OR" },
                { data: "P", title: "P" }
            ];

            // Create columns with custom rendering
            const columns = columnDefinitions.map(col => ({
                data: col.data,
                title: col.title,
                render: function (data, type, row) {
                    if (type === 'display' && col.data === 'Phecode') {
                        return `<a href="/phecode/${data}" target="_blank">${data}</a>`;
                    }
                    return data;
                }
            }));

            // Initialize the DataTable using the common function
            initializeDataTable('phewasTable', data, columns, {
                order: [[columns.length - 1, 'asc']] // Default ordering by the last column (P-value)
            });
        }
    });
</script>
{% endblock %}