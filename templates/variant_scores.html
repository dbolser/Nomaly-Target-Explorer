{% extends "data_base.html" %}

{% block title %}Variant Scores - {{ data.phecode }} - {{ data.term }}{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
    .variant-cell {
        max-width: 400px;
        display: inline-block;
        word-break: normal;
    }

    .variant-cell a {
        display: inline;
        white-space: nowrap;
    }

    td .variant-cell {
        width: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">

    {% include 'partials/term_details.html' %}
    {% include 'partials/phecode_details.html' %}

    <h2>Top Variants for Disease {{ disease_code }} and Term {{ term }}</h2>

    <div id="loading-box" class="alert alert-info">
        <h4>Processing...</h4>
        <div id="progress-messages" class="mt-2">
            <pre id="log-output" style="max-height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px;"></pre>
        </div>
    </div>

    <div id="results" style="display: none;">
        <h3 class="mt-4">Top Gene Set</h3>
        <div id="gene-set-tableContainer"></div>

        <h3 class="mt-4">Top Variants</h3>
        <div id="variants-tableContainer"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const logOutput = document.getElementById('log-output');
        const loadingBox = document.getElementById('loading-box');
        const results = document.getElementById('results');

        function createVariantLink(variant) {
            const urlVariant = variant.replace('/', '_');
            return `<a href="/variant/${urlVariant}">${variant}</a>`;
        }

        // Connect to SSE endpoint
        const source = new EventSource("{{url_for('prioritisation.stream_progress', disease_code = disease_code, term = term, flush = flush | int if flush else none)}}");

        source.onmessage = function (event) {
            try {
                const message = JSON.parse(event.data);
                console.log('Received message:', message);  // Debug logging

                switch (message.type) {
                    case 'progress':
                        const time = new Date().toLocaleTimeString();
                        logOutput.textContent += `[${time}] ${message.data}\n`;
                        logOutput.scrollTop = logOutput.scrollHeight;
                        break;

                    case 'results':
                        // Initialize gene set table
                        const geneSetColumns = Object.keys(message.data.top_gene_set[0]).map(key => ({
                            data: key,
                            title: key.replace(/_/g, ' '),
                            render: key === 'variant_id' ?
                                (data, type) => {
                                    if (type === 'display' && data) {
                                        const links = data.split(', ').map(createVariantLink).join(', ');
                                        return `<div class="variant-cell" title="${data}">${links}</div>`;
                                    }
                                    return data;
                                } :
                                null
                        }));
                        const hmmScoreIndex = geneSetColumns.findIndex(col => col.data === 'hmm_score');
                        initializeDataTable('gene-set-table', message.data.top_gene_set, geneSetColumns, {
                            pageLength: 10,
                            order: [[hmmScoreIndex, 'desc']],
                            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]]
                        });

                        // Initialize variants table
                        const variantColumns = Object.keys(message.data.top_variants[0]).map(key => ({
                            data: key,
                            title: key.replace(/_/g, ' '),
                            render: key === 'variant_id' ?
                                (data, type) => {
                                    if (type === 'display') {
                                        return `<div class="variant-cell" title="${data}">${createVariantLink(data)}</div>`;
                                    }
                                    return data;
                                } :
                                null
                        }));
                        const variantHmmScoreIndex = variantColumns.findIndex(col => col.data === 'hmm_score');
                        initializeDataTable('variants-table', message.data.top_variants, variantColumns, {
                            pageLength: 10,
                            order: [[variantHmmScoreIndex, 'desc']],
                            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]]
                        });

                        results.style.display = 'block';
                        break;

                    case 'error':
                        logOutput.textContent += `ERROR: ${message.data}\n`;
                        logOutput.scrollTop = logOutput.scrollHeight;
                        break;

                    case 'done':
                        source.close();
                        loadingBox.style.display = 'none';
                        break;
                }
            } catch (e) {
                console.error('Error processing message:', e, event.data);
                logOutput.textContent += `Error processing message: ${e}\n`;
            }
        };

        source.onerror = function (event) {
            console.error('SSE error:', event);
            source.close();
            logOutput.textContent += 'Connection error occurred.\n';
        };
    });
</script>
{% endblock %}