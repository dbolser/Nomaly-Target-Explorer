{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Top Variants for Disease {{ disease_code }} and Term {{ term }}</h2>

    <div id="loading-box" class="alert alert-info">
        <h4>Processing...</h4>
        <pre id="log-output" style="max-height: 200px; overflow-y: auto;"></pre>
    </div>

    <div id="results" style="display: none;">
        <h3 class="mt-4">Top Gene Set</h3>
        <div id="gene-set-table"></div>

        <h3 class="mt-4">Top Variants</h3>
        <div id="variants-table"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const logOutput = document.getElementById('log-output');
        const loadingBox = document.getElementById('loading-box');
        const results = document.getElementById('results');
        const geneSetTable = document.getElementById('gene-set-table');
        const variantsTable = document.getElementById('variants-table');

        function createTable(data, container) {
            if (!data || data.length === 0) return;

            // Get columns from first row
            const columns = Object.keys(data[0]);

            // Create table HTML
            let html = '<table class="table table-striped">';

            // Header
            html += '<thead><tr>';
            columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead>';

            // Body
            html += '<tbody>';
            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    html += `<td>${row[col]}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';

            container.innerHTML = html;
        }

        // Connect to SSE endpoint
        const source = new EventSource("{{ url_for('prioritisation.stream_progress', disease_code=disease_code, term=term) }}");

        source.onmessage = function (event) {
            const message = JSON.parse(event.data);

            switch (message.type) {
                case 'progress':
                    logOutput.textContent += message.data + '\n';
                    logOutput.scrollTop = logOutput.scrollHeight;
                    break;

                case 'results':
                    createTable(message.data.top_gene_set, geneSetTable);
                    createTable(message.data.top_variants, variantsTable);
                    results.style.display = 'block';
                    break;

                case 'error':
                    logOutput.textContent += 'Error: ' + message.data + '\n';
                    logOutput.scrollTop = logOutput.scrollHeight;
                    break;

                case 'done':
                    source.close();
                    loadingBox.style.display = 'none';
                    break;
            }
        };

        source.onerror = function (event) {
            console.error('SSE error:', event);
            source.close();
            logOutput.textContent += 'Connection error occurred.\n';
        };
    });
</script>
{% endblock %}